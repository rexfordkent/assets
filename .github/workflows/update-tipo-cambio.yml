name: Actualizar Tipo de Cambio

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-rates:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
    
    - name: Crear script Python
      run: |
        cat > scraper.py << 'ENDOFSCRIPT'
        import requests
        from bs4 import BeautifulSoup
        import json
        import re
        from datetime import datetime
        
        def get_sunat():
            try:
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
                
                response = requests.get(
                    'https://e-consulta.sunat.gob.pe/cl-at-ittipcam/tcS01Alias',
                    headers=headers,
                    verify=False,
                    timeout=30
                )
                
                if response.status_code == 200:
                    soup = BeautifulSoup(response.text, 'html.parser')
                    
                    dia_actual = datetime.now().day
                    
                    tds = soup.find_all('td')
                    
                    for i, td in enumerate(tds):
                        if td.text.strip() == str(dia_actual):
                            if i + 1 < len(tds):
                                next_td = tds[i + 1]
                                text = next_td.text
                                
                                numeros = re.findall(r'\d+\.\d{3}', text)
                                
                                if len(numeros) >= 2:
                                    compra = float(numeros[0])
                                    venta = float(numeros[1])
                                    
                                    print(f"SUNAT dia {dia_actual}: {compra}/{venta}")
                                    
                                    return {
                                        "compra": compra,
                                        "venta": venta,
                                        "fecha": datetime.now().strftime("%d/%m/%Y")
                                    }
                    
                    for i, td in enumerate(tds):
                        if td.text.strip() == str(dia_actual - 1):
                            if i + 1 < len(tds):
                                next_td = tds[i + 1]
                                text = next_td.text
                                numeros = re.findall(r'\d+\.\d{3}', text)
                                
                                if len(numeros) >= 2:
                                    compra = float(numeros[0])
                                    venta = float(numeros[1])
                                    
                                    print(f"SUNAT dia {dia_actual-1}: {compra}/{venta}")
                                    
                                    return {
                                        "compra": compra,
                                        "venta": venta,
                                        "fecha": f"{dia_actual-1:02d}/{datetime.now().month:02d}/{datetime.now().year}"
                                    }
                    
                    print("SUNAT: No se encontro el dia")
                    
            except Exception as e:
                print(f"Error SUNAT: {e}")
            
            return {"error": True, "message": "No se pudo obtener de SUNAT"}
        
        def get_sbs():
            try:
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
                
                response = requests.get(
                    'https://www.sbs.gob.pe/app/pp/sistip_portal/paginas/publicacion/tipocambiopromedio.aspx',
                    headers=headers,
                    verify=False,
                    timeout=30
                )
                
                if response.status_code == 200:
                    soup = BeautifulSoup(response.text, 'html.parser')
                    
                    tables = soup.find_all('table')
                    
                    for table in tables:
                        rows = table.find_all('tr')
                        for row in rows:
                            if 'lar de N.A.' in row.text:
                                tds = row.find_all('td')
                                if len(tds) >= 3:
                                    try:
                                        compra = float(tds[1].text.strip())
                                        venta = float(tds[2].text.strip())
                                        
                                        print(f"SBS encontrado: {compra}/{venta}")
                                        
                                        return {
                                            "compra": compra,
                                            "venta": venta,
                                            "fecha": datetime.now().strftime("%d/%m/%Y")
                                        }
                                    except:
                                        pass
                    
                    text = soup.get_text()
                    numeros = re.findall(r'3\.\d{3}', text)
                    
                    if len(numeros) >= 2:
                        valores = [float(n) for n in numeros if 3.4 <= float(n) <= 3.8]
                        if len(valores) >= 2:
                            print(f"SBS valores encontrados: {valores[0]}/{valores[1]}")
                            return {
                                "compra": valores[0],
                                "venta": valores[1],
                                "fecha": datetime.now().strftime("%d/%m/%Y")
                            }
                    
                    print("SBS: No se encontraron valores")
                    
            except Exception as e:
                print(f"Error SBS: {e}")
            
            return {"error": True, "message": "No se pudo obtener de SBS"}
        
        print("=" * 50)
        print("INICIANDO SCRAPING REAL")
        print("=" * 50)
        
        sunat_data = get_sunat()
        sbs_data = get_sbs()
        
        result = {
            "sunat": sunat_data,
            "sbs": sbs_data,
            "ultima_actualizacion": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        
        with open('tipo-cambio.json', 'w', encoding='utf-8') as f:
            json.dump(result, f, indent=2, ensure_ascii=False)
        
        print("\n" + "=" * 50)
        print("RESULTADO FINAL:")
        print(f"SUNAT: {sunat_data}")
        print(f"SBS: {sbs_data}")
        print("=" * 50)
        
        if (not sunat_data.get('error')) or (not sbs_data.get('error')):
            print("OK: Datos obtenidos exitosamente")
        else:
            print("WARNING: No se pudieron obtener datos")
        ENDOFSCRIPT
    
    - name: Ejecutar scraper
      run: python scraper.py
    
    - name: Mostrar contenido del JSON
      run: |
        echo "===== CONTENIDO DE tipo-cambio.json ====="
        cat tipo-cambio.json
    
    - name: Commit y Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add tipo-cambio.json
        git commit -m "Actualizar tipo de cambio REAL - $(date +'%d/%m/%Y %H:%M')" || echo "No changes"
        git push || echo "Nothing to push"
