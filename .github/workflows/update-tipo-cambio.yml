name: Actualizar Tipo de Cambio

on:
  schedule:
    # Ejecutar cada hora a los 5 minutos
    - cron: '5 * * * *'
  workflow_dispatch: # Permitir ejecución manual
  push:
    branches: [ main ]

jobs:
  update-rates:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Obtener Tipo de Cambio
      run: |
        cat > update.php << 'EOF'
        <?php
        date_default_timezone_set('America/Lima');
        
        function get_tipo_cambio($source) {
            $urls = [
                'sunat' => 'https://e-consulta.sunat.gob.pe/cl-at-ittipcam/tcS01Alias',
                'sbs' => 'https://www.sbs.gob.pe/app/pp/sistip_portal/paginas/publicacion/tipocambiopromedio.aspx'
            ];
            
            $ctx = stream_context_create([
                'http' => [
                    'timeout' => 30,
                    'user_agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                ],
                'ssl' => [
                    'verify_peer' => false,
                    'verify_peer_name' => false
                ]
            ]);
            
            $html = @file_get_contents($urls[$source], false, $ctx);
            
            if (!$html) {
                return ['error' => true, 'message' => 'No se pudo conectar'];
            }
            
            // Para SUNAT
            if ($source === 'sunat') {
                $dia = date('j');
                if (preg_match('/<td[^>]*>\s*' . $dia . '\s*<\/td>.*?([3-4]\.[0-9]{3}).*?([3-4]\.[0-9]{3})/si', $html, $matches)) {
                    return [
                        'compra' => floatval($matches[1]),
                        'venta' => floatval($matches[2]),
                        'fecha' => date('d/m/Y')
                    ];
                }
            }
            
            // Para SBS o valores genéricos
            if (preg_match_all('/([3-4]\.[0-9]{3})/', $html, $matches)) {
                $valores = array_map('floatval', $matches[1]);
                $valores = array_filter($valores, function($v) {
                    return $v >= 3.4 && $v <= 3.7;
                });
                
                if (count($valores) >= 2) {
                    $valores = array_values($valores);
                    return [
                        'compra' => min($valores[0], $valores[1]),
                        'venta' => max($valores[0], $valores[1]),
                        'fecha' => date('d/m/Y')
                    ];
                }
            }
            
            return ['error' => true, 'message' => 'No se encontraron valores'];
        }
        
        $result = [
            'sunat' => get_tipo_cambio('sunat'),
            'sbs' => get_tipo_cambio('sbs'),
            'ultima_actualizacion' => date('Y-m-d H:i:s')
        ];
        
        file_put_contents('tipo-cambio.json', json_encode($result, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        
        echo "Actualizado: " . date('Y-m-d H:i:s') . "\n";
        echo "SUNAT: " . ($result['sunat']['error'] ?? false ? 'Error' : $result['sunat']['compra'] . '/' . $result['sunat']['venta']) . "\n";
        echo "SBS: " . ($result['sbs']['error'] ?? false ? 'Error' : $result['sbs']['compra'] . '/' . $result['sbs']['venta']) . "\n";
        EOF
        
        php update.php
    
    - name: Commit y Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add tipo-cambio.json
        git diff --quiet && git diff --staged --quiet || git commit -m "Actualizar tipo de cambio - $(date +'%d/%m/%Y %H:%M')"
        git push
